name: iOS CI

# ----------------------------------------
# トリガー条件
# ----------------------------------------
on:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]
   
# ----------------------------------------
# 環境変数
# ----------------------------------------
env:
  # チェックアウト
  DEVELOPER_DIR: /Applications/Xcode_16.4.app

jobs:
  build-and-test:
    # デフォルトブランチへの push または PR のときに実行
    if: ${{ github.ref_name == github.event.repository.default_branch || github.event_name == 'pull_request' }}
    runs-on: macos-15     # GitHub提供のmacOSランナーで実行

    steps:
      # 1. リポジトリをチェックアウト
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      # 2. DerivedData をキャッシュ
      - name: Cache DerivedData
        uses: actions/cache@v4.2.3
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-xcode-derived-${{ hashFiles('**/*.swift') }}
          restore-keys: |
            ${{ runner.os }}-xcode-derived-

      # 3. Xcodeの一覧出力
      - name: Show Xcode list
        run: ls /Applications | grep 'Xcode'
      # Xcodeのバージョン選択
      - name: Select Xcode version
        run: sudo xcode-select -s '${{ env.DEVELOPER_DIR }}/Contents/Developer'

      # 4. SPM 依存解決（Moya など）
      - name: Resolve Swift Packages
        run: |
          xcodebuild \
            -project Linktape.xcodeproj \
            -resolvePackageDependencies

      # 5. SwiftLint プラグイン実行
      - name: Lint via SwiftLint BuildTool Plugin
        run: swift package plugin run SwiftLintBuildToolPlugin --target Linktape

      # 6. ビルド ＆ テスト
      - name: Build and test
        run: |
          xcodebuild test \
            -project Linktape.xcodeproj \
            -scheme Linktape \
            -destination 'platform=iOS Simulator,OS=18.5,name=iPhone 16 Pro' \
            -enableCodeCoverage YES \
          | xcpretty
